local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏
local FLY_SPEED = 50
local FLYING = false
local FLY_CONNECTION = nil

-- –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–µ—Ä—ã
local originalCameraType = workspace.CurrentCamera.CameraType
local originalCameraSubject = workspace.CurrentCamera.CameraSubject

local function GetTargetPosition(target)
    -- –î–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    if type(target) == "string" and target:find(",") then
        local coords = {}
        for num in target:gmatch("-?%d+") do
            table.insert(coords, tonumber(num))
        end
        if #coords == 3 then
            return Vector3.new(coords[1], coords[2], coords[3])
        end
    end
    
    -- –î–ª—è –æ–±—ä–µ–∫—Ç–æ–≤
    local success, obj = pcall(function()
        if type(target) == "string" then
            local corrected = target
                :gsub('game:GetService%("', 'game:GetService(\'')
                :gsub('")', '\')')
            return loadstring("return "..corrected)()
        end
        return target
    end)
    
    if success and obj then
        if obj:IsA("BasePart") then
            -- –î–ª—è —á–∞—Å—Ç–µ–π - —Ü–µ–Ω—Ç—Ä –æ–±—ä–µ–∫—Ç–∞
            return obj.Position
        elseif obj:IsA("Model") then
            local part = obj.PrimaryPart or obj:FindFirstChildWhichIsA("BasePart")
            if part then
                -- –î–ª—è –º–æ–¥–µ–ª–µ–π - —Ü–µ–Ω—Ç—Ä –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Å—Ç–∏
                return part.Position
            end
        end
    end
    
    return nil
end

getgenv().FLYTO = function(target)
    if FLYING then
        warn("‚ö†Ô∏è –£–∂–µ –≤ –ø–æ–ª–µ—Ç–µ! –°–Ω–∞—á–∞–ª–∞ STOPFLY()")
        return
    end

    -- –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏
    Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    Humanoid = Character:FindFirstChild("Humanoid")
    HumanoidRootPart = Character:FindFirstChild("HumanoidRootPart")

    if not Humanoid or not HumanoidRootPart then
        warn("‚ùå –ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –≥–æ—Ç–æ–≤")
        return
    end

    local targetPos = GetTargetPosition(target)
    if not targetPos then
        warn("‚ùå –¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: "..tostring(target))
        return
    end

    -- –§–∏–∫—Å–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ
    workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    workspace.CurrentCamera.CameraSubject = Humanoid

    -- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–∑–∏–∫–∏
    local originalGravity = workspace.Gravity
    local originalPlatformStand = Humanoid.PlatformStand
    workspace.Gravity = 0
    Humanoid.PlatformStand = true
    FLYING = true

    local startTime = tick()
    local startPos = HumanoidRootPart.Position
    local distance = (targetPos - startPos).Magnitude
    local direction = (targetPos - startPos).Unit

    FLY_CONNECTION = RunService.Heartbeat:Connect(function(delta)
        if not FLYING or not Character or not Character.Parent then
            STOPFLY()
            return
        end

        HumanoidRootPart = Character:FindFirstChild("HumanoidRootPart")
        if not HumanoidRootPart then
            STOPFLY()
            return
        end

        local currentPos = HumanoidRootPart.Position
        local currentDistance = (targetPos - currentPos).Magnitude
        
        -- –î–æ—Å—Ç–∏–≥–ª–∏ —Ü–µ–ª–∏
        if currentDistance < 2 then
            -- –¢–æ—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞
            HumanoidRootPart.CFrame = CFrame.new(targetPos)
            STOPFLY()
            print("‚úÖ –î–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ —Ü–µ–ª—å: "..tostring(target))
            return
        end

        -- –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
        local flyProgress = (tick() - startTime) * FLY_SPEED
        local moveStep = math.min(flyProgress, distance)
        local newPos = startPos + (direction * moveStep)
        
        HumanoidRootPart.CFrame = CFrame.new(newPos, targetPos)
    end)

    print("üõ´ –ü–æ–ª–µ—Ç –∫: "..tostring(target))
end

getgenv().STOPFLY = function()
    if not FLYING then return end
    
    FLYING = false
    
    if FLY_CONNECTION then
        FLY_CONNECTION:Disconnect()
        FLY_CONNECTION = nil
    end
    
    -- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if workspace then
        workspace.Gravity = 196.2
    end
    
    if Character and Humanoid then
        Humanoid.PlatformStand = false
        Humanoid:ChangeState(Enum.HumanoidStateType.Running)
    end
    
    -- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
    if workspace.CurrentCamera then
        workspace.CurrentCamera.CameraSubject = Humanoid
    end
    
    print("‚úã –ü–æ–ª–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
end

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    STOPFLY()
end)
