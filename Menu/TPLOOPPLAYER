local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

-- Создаем основной GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "LoopMenu"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

-- Основное окно
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 394, 0, 331)
MainFrame.Position = UDim2.new(0.146, 0, 0.3, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

-- Верхняя панель
local TopBar = Instance.new("Frame")
TopBar.Name = "TopBar"
TopBar.Size = UDim2.new(1, 0, 0, 50)
TopBar.Position = UDim2.new(0, 0, 0, 0)
TopBar.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
TopBar.BorderSizePixel = 0

local TopBarCorner = Instance.new("UICorner")
TopBarCorner.CornerRadius = UDim.new(0, 8)
TopBarCorner.Parent = TopBar

-- Заголовок
local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Size = UDim2.new(0, 200, 1, 0)
Title.Position = UDim2.new(0.5, -100, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "Loop Menu"
Title.TextColor3 = Color3.fromRGB(253, 104, 159)
Title.TextSize = 31
Title.Font = Enum.Font.SourceSansBold
Title.TextStrokeTransparency = 0.8

-- Иконка
local Icon = Instance.new("ImageLabel")
Icon.Name = "Icon"
Icon.Size = UDim2.new(0, 22, 0, 22)
Icon.Position = UDim2.new(0, 15, 0.5, -11)
Icon.BackgroundTransparency = 1
Icon.Image = "rbxassetid://7733774602"
Icon.ImageColor3 = Color3.fromRGB(253, 104, 159)

-- Декоративная полоска
local DecorativeLine = Instance.new("Frame")
DecorativeLine.Name = "DecorativeLine"
DecorativeLine.Size = UDim2.new(0, 5, 0, 16)
DecorativeLine.Position = UDim2.new(0, 42, 0.5, -8)
DecorativeLine.BackgroundColor3 = Color3.fromRGB(253, 104, 159)
DecorativeLine.BorderSizePixel = 0

-- Кнопка свернуть
local MinimizeButton = Instance.new("Frame")
MinimizeButton.Name = "MinimizeButton"
MinimizeButton.Size = UDim2.new(0, 30, 0, 31)
MinimizeButton.Position = UDim2.new(1, -70, 0.5, -15.5)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(239, 239, 239)
MinimizeButton.BorderSizePixel = 0

local MinimizeCorner = Instance.new("UICorner")
MinimizeCorner.CornerRadius = UDim.new(0, 8)
MinimizeCorner.Parent = MinimizeButton

local MinimizeText = Instance.new("TextLabel")
MinimizeText.Name = "MinimizeText"
MinimizeText.Size = UDim2.new(1, 0, 1, 0)
MinimizeText.BackgroundTransparency = 1
MinimizeText.Text = "-"
MinimizeText.TextColor3 = Color3.fromRGB(253, 104, 159)
MinimizeText.TextSize = 20
MinimizeText.Font = Enum.Font.SourceSansBold

local MinimizeImageButton = Instance.new("ImageButton")
MinimizeImageButton.Name = "MinimizeImageButton"
MinimizeImageButton.Size = UDim2.new(1, 0, 1, 0)
MinimizeImageButton.BackgroundTransparency = 1
MinimizeImageButton.Image = ""

-- Кнопка закрыть
local CloseButton = Instance.new("Frame")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 30, 0, 31)
CloseButton.Position = UDim2.new(1, -35, 0.5, -15.5)
CloseButton.BackgroundColor3 = Color3.fromRGB(213, 7, 69)
CloseButton.BorderSizePixel = 0

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseButton

local CloseText = Instance.new("TextLabel")
CloseText.Name = "CloseText"
CloseText.Size = UDim2.new(1, 0, 1, 0)
CloseText.BackgroundTransparency = 1
CloseText.Text = "X"
CloseText.TextColor3 = Color3.fromRGB(253, 104, 159)
CloseText.TextSize = 20
CloseText.Font = Enum.Font.SourceSansBold

local CloseImageButton = Instance.new("ImageButton")
CloseImageButton.Name = "CloseImageButton"
CloseImageButton.Size = UDim2.new(1, 0, 1, 0)
CloseImageButton.BackgroundTransparency = 1
CloseImageButton.Image = ""

-- Основная область контента
local ContentFrame = Instance.new("Frame")
ContentFrame.Name = "ContentFrame"
ContentFrame.Size = UDim2.new(1, 0, 1, -50)
ContentFrame.Position = UDim2.new(0, 0, 0, 50)
ContentFrame.BackgroundTransparency = 1

-- Кнопка выбора игрока
local SelectPlayerButton = Instance.new("TextButton")
SelectPlayerButton.Name = "SelectPlayerButton"
SelectPlayerButton.Size = UDim2.new(0.8, 0, 0, 40)
SelectPlayerButton.Position = UDim2.new(0.1, 0, 0.05, 0)
SelectPlayerButton.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
SelectPlayerButton.TextColor3 = Color3.fromRGB(253, 104, 159)
SelectPlayerButton.Text = "Выбрать игрока"
SelectPlayerButton.TextSize = 18
SelectPlayerButton.Font = Enum.Font.SourceSansBold

local SelectPlayerCorner = Instance.new("UICorner")
SelectPlayerCorner.CornerRadius = UDim.new(0, 8)
SelectPlayerCorner.Parent = SelectPlayerButton

-- Поле выбранного игрока
local SelectedPlayerLabel = Instance.new("TextLabel")
SelectedPlayerLabel.Name = "SelectedPlayerLabel"
SelectedPlayerLabel.Size = UDim2.new(0.8, 0, 0, 30)
SelectedPlayerLabel.Position = UDim2.new(0.1, 0, 0.2, 0)
SelectedPlayerLabel.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
SelectedPlayerLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
SelectedPlayerLabel.Text = "Не выбран"
SelectedPlayerLabel.TextSize = 16
SelectedPlayerLabel.Font = Enum.Font.SourceSans

local SelectedPlayerCorner = Instance.new("UICorner")
SelectedPlayerCorner.CornerRadius = UDim.new(0, 8)
SelectedPlayerCorner.Parent = SelectedPlayerLabel

-- Интервал телепортации
local IntervalLabel = Instance.new("TextLabel")
IntervalLabel.Name = "IntervalLabel"
IntervalLabel.Size = UDim2.new(0.4, 0, 0, 25)
IntervalLabel.Position = UDim2.new(0.1, 0, 0.35, 0)
IntervalLabel.BackgroundTransparency = 1
IntervalLabel.TextColor3 = Color3.fromRGB(253, 104, 159)
IntervalLabel.Text = "Интервал (сек):"
IntervalLabel.TextSize = 18
IntervalLabel.Font = Enum.Font.SourceSansBold
IntervalLabel.TextXAlignment = Enum.TextXAlignment.Left

local IntervalTextBox = Instance.new("TextBox")
IntervalTextBox.Name = "IntervalTextBox"
IntervalTextBox.Size = UDim2.new(0.4, 0, 0, 35)
IntervalTextBox.Position = UDim2.new(0.5, 0, 0.35, 0)
IntervalTextBox.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
IntervalTextBox.TextColor3 = Color3.fromRGB(253, 104, 159)
IntervalTextBox.Text = "0.1"
IntervalTextBox.TextSize = 16
IntervalTextBox.Font = Enum.Font.SourceSans
IntervalTextBox.PlaceholderText = "0.1"
IntervalTextBox.ClearTextOnFocus = false

local IntervalCorner = Instance.new("UICorner")
IntervalCorner.CornerRadius = UDim.new(0, 8)
IntervalCorner.Parent = IntervalTextBox

-- Переключатель включения
local ToggleFrame = Instance.new("Frame")
ToggleFrame.Name = "ToggleFrame"
ToggleFrame.Size = UDim2.new(0.8, 0, 0, 40)
ToggleFrame.Position = UDim2.new(0.1, 0, 0.55, 0)
ToggleFrame.BackgroundTransparency = 1

local ToggleLabel = Instance.new("TextLabel")
ToggleLabel.Name = "ToggleLabel"
ToggleLabel.Size = UDim2.new(0.6, 0, 1, 0)
ToggleLabel.Position = UDim2.new(0, 0, 0, 0)
ToggleLabel.BackgroundTransparency = 1
ToggleLabel.TextColor3 = Color3.fromRGB(253, 104, 159)
ToggleLabel.Text = "Включить телепортацию"
ToggleLabel.TextSize = 18
ToggleLabel.Font = Enum.Font.SourceSansBold
ToggleLabel.TextXAlignment = Enum.TextXAlignment.Left

local ToggleButton = Instance.new("Frame")
ToggleButton.Name = "ToggleButton"
ToggleButton.Size = UDim2.new(0, 50, 0, 25)
ToggleButton.Position = UDim2.new(1, -50, 0.5, -12.5)
ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
ToggleButton.BorderSizePixel = 0

local ToggleButtonCorner = Instance.new("UICorner")
ToggleButtonCorner.CornerRadius = UDim.new(1, 0)
ToggleButtonCorner.Parent = ToggleButton

local ToggleCircle = Instance.new("Frame")
ToggleCircle.Name = "ToggleCircle"
ToggleCircle.Size = UDim2.new(0, 21, 0, 21)
ToggleCircle.Position = UDim2.new(0, 2, 0.5, -10.5)
ToggleCircle.BackgroundColor3 = Color3.fromRGB(253, 104, 159)
ToggleCircle.BorderSizePixel = 0

local ToggleCircleCorner = Instance.new("UICorner")
ToggleCircleCorner.CornerRadius = UDim.new(1, 0)
ToggleCircleCorner.Parent = ToggleCircle

local ToggleImageButton = Instance.new("ImageButton")
ToggleImageButton.Name = "ToggleImageButton"
ToggleImageButton.Size = UDim2.new(1, 0, 1, 0)
ToggleImageButton.BackgroundTransparency = 1
ToggleImageButton.Image = ""

-- Кнопка отключения скрипта
local DisableScriptButton = Instance.new("TextButton")
DisableScriptButton.Name = "DisableScriptButton"
DisableScriptButton.Size = UDim2.new(0.8, 0, 0, 40)
DisableScriptButton.Position = UDim2.new(0.1, 0, 0.8, 0)
DisableScriptButton.BackgroundColor3 = Color3.fromRGB(213, 7, 69)
DisableScriptButton.TextColor3 = Color3.fromRGB(255, 255, 255)
DisableScriptButton.Text = "Отключить скрипт"
DisableScriptButton.TextSize = 18
DisableScriptButton.Font = Enum.Font.SourceSansBold

local DisableScriptCorner = Instance.new("UICorner")
DisableScriptCorner.CornerRadius = UDim.new(0, 8)
DisableScriptCorner.Parent = DisableScriptButton

-- Выпадающий список игроков
local DropdownFrame = Instance.new("Frame")
DropdownFrame.Name = "DropdownFrame"
DropdownFrame.Size = UDim2.new(0.8, 0, 0, 200)
DropdownFrame.Position = UDim2.new(0.1, 0, 0.05, 45)
DropdownFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
DropdownFrame.Visible = false
DropdownFrame.ZIndex = 10

local DropdownCorner = Instance.new("UICorner")
DropdownCorner.CornerRadius = UDim.new(0, 8)
DropdownCorner.Parent = DropdownFrame

local SearchTextBox = Instance.new("TextBox")
SearchTextBox.Name = "SearchTextBox"
SearchTextBox.Size = UDim2.new(0.9, 0, 0, 30)
SearchTextBox.Position = UDim2.new(0.05, 0, 0, 10)
SearchTextBox.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
SearchTextBox.TextColor3 = Color3.fromRGB(253, 104, 159)
SearchTextBox.Text = ""
SearchTextBox.TextSize = 16
SearchTextBox.Font = Enum.Font.SourceSans
SearchTextBox.PlaceholderText = "Поиск по нику..."
SearchTextBox.ClearTextOnFocus = false
SearchTextBox.ZIndex = 11

local SearchCorner = Instance.new("UICorner")
SearchCorner.CornerRadius = UDim.new(0, 8)
SearchCorner.Parent = SearchTextBox

local PlayersScrollingFrame = Instance.new("ScrollingFrame")
PlayersScrollingFrame.Name = "PlayersScrollingFrame"
PlayersScrollingFrame.Size = UDim2.new(0.9, 0, 0, 150)
PlayersScrollingFrame.Position = UDim2.new(0.05, 0, 0, 50)
PlayersScrollingFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
PlayersScrollingFrame.BorderSizePixel = 0
PlayersScrollingFrame.ScrollBarThickness = 5
PlayersScrollingFrame.ZIndex = 11

local PlayersListLayout = Instance.new("UIListLayout")
PlayersListLayout.Parent = PlayersScrollingFrame
PlayersListLayout.SortOrder = Enum.SortOrder.LayoutOrder
PlayersListLayout.Padding = UDim.new(0, 5)

-- Переменные состояния
local isMinimized = false
local isDragging = false
local dragStart
local startPos
local isTeleporting = false
local teleportConnection
local selectedPlayer = nil
local originalHeight = 331

-- Собираем GUI
MinimizeText.Parent = MinimizeButton
MinimizeImageButton.Parent = MinimizeButton

CloseText.Parent = CloseButton
CloseImageButton.Parent = CloseButton

ToggleCircle.Parent = ToggleButton
ToggleImageButton.Parent = ToggleButton
ToggleLabel.Parent = ToggleFrame
ToggleButton.Parent = ToggleFrame

SearchTextBox.Parent = DropdownFrame
PlayersScrollingFrame.Parent = DropdownFrame
DropdownFrame.Parent = ContentFrame

SelectPlayerButton.Parent = ContentFrame
SelectedPlayerLabel.Parent = ContentFrame
IntervalLabel.Parent = ContentFrame
IntervalTextBox.Parent = ContentFrame
ToggleFrame.Parent = ContentFrame
DisableScriptButton.Parent = ContentFrame

Icon.Parent = TopBar
DecorativeLine.Parent = TopBar
Title.Parent = TopBar
MinimizeButton.Parent = TopBar
CloseButton.Parent = TopBar
TopBar.Parent = MainFrame
ContentFrame.Parent = MainFrame
MainFrame.Parent = ScreenGui
ScreenGui.Parent = game:GetService("CoreGui")

-- Функции
local function updatePlayersList(searchText)
    PlayersScrollingFrame:ClearAllChildren()
    
    local players = Players:GetPlayers()
    local yOffset = 0
    
    for _, player in pairs(players) do
        if player ~= LocalPlayer then
            local playerName = player.Name
            local displayName = player.DisplayName
            
            if searchText == "" or 
               string.find(string.lower(playerName), string.lower(searchText)) or
               string.find(string.lower(displayName), string.lower(searchText)) then
                
                local playerButton = Instance.new("TextButton")
                playerButton.Name = playerName
                playerButton.Size = UDim2.new(1, 0, 0, 30)
                playerButton.Position = UDim2.new(0, 0, 0, yOffset)
                playerButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
                playerButton.TextColor3 = Color3.fromRGB(253, 104, 159)
                playerButton.Text = playerName
                playerButton.TextSize = 16
                playerButton.Font = Enum.Font.SourceSans
                playerButton.ZIndex = 12
                
                local playerButtonCorner = Instance.new("UICorner")
                playerButtonCorner.CornerRadius = UDim.new(0, 6)
                playerButtonCorner.Parent = playerButton
                
                playerButton.MouseButton1Click:Connect(function()
                    selectedPlayer = player
                    SelectedPlayerLabel.Text = playerName
                    DropdownFrame.Visible = false
                end)
                
                playerButton.Parent = PlayersScrollingFrame
                yOffset = yOffset + 35
            end
        end
    end
    
    PlayersScrollingFrame.CanvasSize = UDim2.new(0, 0, 0, yOffset)
end

local function toggleTeleportation()
    if not isTeleporting then
        -- Включаем телепортацию
        if selectedPlayer then
            local interval = tonumber(IntervalTextBox.Text) or 0.1
            isTeleporting = true
            
            -- Анимация переключателя
            local tween = TweenService:Create(
                ToggleCircle,
                TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut),
                {Position = UDim2.new(1, -23, 0.5, -10.5)}
            )
            tween:Play()
            
            ToggleButton.BackgroundColor3 = Color3.fromRGB(80, 200, 120)
            
            -- Запускаем телепортацию
            teleportConnection = RunService.Heartbeat:Connect(function()
                if selectedPlayer and selectedPlayer.Character and selectedPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                        LocalPlayer.Character.HumanoidRootPart.CFrame = selectedPlayer.Character.HumanoidRootPart.CFrame
                    end
                else
                    -- Если игрок вышел, останавливаем телепортацию
                    isTeleporting = false
                    if teleportConnection then
                        teleportConnection:Disconnect()
                    end
                    
                    local tween = TweenService:Create(
                        ToggleCircle,
                        TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut),
                        {Position = UDim2.new(0, 2, 0.5, -10.5)}
                    )
                    tween:Play()
                    ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                    SelectedPlayerLabel.Text = "Игрок вышел"
                    selectedPlayer = nil
                end
            end)
        else
            SelectedPlayerLabel.Text = "Сначала выберите игрока!"
        end
    else
        -- Выключаем телепортацию
        isTeleporting = false
        if teleportConnection then
            teleportConnection:Disconnect()
        end
        
        -- Анимация переключателя
        local tween = TweenService:Create(
            ToggleCircle,
            TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut),
            {Position = UDim2.new(0, 2, 0.5, -10.5)}
        )
        tween:Play()
        
        ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    end
end

-- Обработчики событий
-- Перетаскивание окна
TopBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
    end
end)

TopBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and isDragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

TopBar.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = false
    end
end)

-- Кнопка сворачивания
MinimizeImageButton.MouseButton1Click:Connect(function()
    if not isMinimized then
        -- Сворачиваем
        MainFrame.Size = UDim2.new(0, 394, 0, 50)
        ContentFrame.Visible = false
        isMinimized = true
    else
        -- Разворачиваем
        MainFrame.Size = UDim2.new(0, 394, 0, originalHeight)
        ContentFrame.Visible = true
        isMinimized = false
    end
end)

-- Кнопка закрытия
CloseImageButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- Кнопка выбора игрока
SelectPlayerButton.MouseButton1Click:Connect(function()
    DropdownFrame.Visible = not DropdownFrame.Visible
    if DropdownFrame.Visible then
        updatePlayersList("")
    end
end)

-- Поиск игроков
SearchTextBox:GetPropertyChangedSignal("Text"):Connect(function()
    updatePlayersList(SearchTextBox.Text)
end)

-- Переключатель телепортации
ToggleImageButton.MouseButton1Click:Connect(function()
    toggleTeleportation()
end)

-- Кнопка отключения скрипта
DisableScriptButton.MouseButton1Click:Connect(function()
    -- Останавливаем телепортацию если активна
    if isTeleporting and teleportConnection then
        teleportConnection:Disconnect()
    end
    ScreenGui:Destroy()
end)

-- Обновление списка игроков при подключении/отключении
Players.PlayerAdded:Connect(function()
    if DropdownFrame.Visible then
        updatePlayersList(SearchTextBox.Text)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    if player == selectedPlayer then
        selectedPlayer = nil
        SelectedPlayerLabel.Text = "Игрок вышел"
        if isTeleporting then
            toggleTeleportation()
        end
    end
    if DropdownFrame.Visible then
        updatePlayersList(SearchTextBox.Text)
    end
end)

-- Инициализация списка игроков
updatePlayersList("")

-- Делаем GUI всегда поверх других
ScreenGui.DisplayOrder = 999
